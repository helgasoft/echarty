<!DOCTYPE html>
<html lang="en">
<head>
	<title>WebR + echarty</title>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width" />
	<link rel="shortcut icon" href="../img/logo.ico" type="image/x-icon">

	<script src="https://cdn.jsdelivr.net/gh/ramnathv/htmlwidgets@v1.6.2/inst/www/htmlwidgets.js"></script>
	
	<!--  echarty dependencies  -->
	<script src="https://cdn.jsdelivr.net/gh/helgasoft/echarty@v.1.6.3/inst/js/echarts.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/echarts-gl@2.0.9/dist/echarts-gl.min.js"></script>
	<script src="https://cdn.jsdelivr.net/gh/helgasoft/echarty@v.1.6.3/inst/htmlwidgets/echarty.min.js"></script>
	<script src="https://cdn.jsdelivr.net/gh/helgasoft/echarty@v.1.6.3/inst/js/renderers.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css">
	<script src="https://cdn.jsdelivr.net/gh/helgasoft/echarty@v.1.6.3/inst/js/echarts-leaflet.min.js"></script>
	<script src="https://cdn.jsdelivr.net/gh/helgasoft/echarty@v.1.6.3/inst/js/world.js"></script>

	<style>
body { font-family: Arial, sans-serif; background-color: Linen; }
a:link { text-decoration: none; }
.titl {font-size: 130%; }
.fontu {font-size: 130%;}
.center { text-align: center; }
.wrapper { display: flex; 
  margin: 0.5rem;   
  width: 100%;
} 
.textarea {
  border: 1px solid #ccc;
  padding: 1px 6px; margin: 5px;
  display: block;
  width: 80%;
  overflow: hidden;
  overflow-y: auto;
  resize: both;
  min-height: 40px;
  line-height: 20px;
  font-family: Verdana,sans-serif;
  font-size: 16px;
  background-color: #f8f8f8;
}
label {
  display: grid;
  /* grid-template-columns: auto 1fr; */
  align-items: center;
  margin-right: 6px;
}
.lefto { margin-left: 30px; }
.bton {font-size: 14px; background-color: PaleTurquoise; border-radius: 6px;}
.err {color: red;}

/* The Modal (background) */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
  background-color: Linen;
  margin: auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
}

/* The Close Button */
.close {
  color: #aaaaaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}

	</style>
</head>

<body>
  <div class='center'>
	<a href='https://github.com/helgasoft/echarty'><span class='titl'>Echarty</span> <img src='../img/logo.png' width=40 /></a> <span class='fontu'>WebR Coder</span>
  </div>

  <!-- The Modal -->
  <div id="myModal" class="modal">
  <!-- Modal content -->
  <div class="modal-content">
    <span class="close">&times;</span>
	<p>
<h4><a href='https://helgasoft.github.io/echarty' target=_blank>echarty</a> Coder on <a href='https://docs.r-wasm.org/webr/latest/' target=_blank>WebR</a></h4>
Live R-code execution inside a single web page. No Rmd files. No server. No installation. At last!
<p>Experiment by setting attributes from <a href='https://echarts.apache.org/en/option.html' target=_blank>ECharts API</a>, for instance adding a title. 
ECharts attributes are defined as named lists in R.
</p>
This page has coding limitations: <ul>
  <li>parameter <i>load</i> for loading extensions like <i>3D</i> or <i>world</i> doesn't work yet. However these same JS extensions could be loaded in page's <i>head</i> section and necessary attributes set manually, see examples <i>surface</i> and <i>map</i>.</li>
  <li>the echarty widget name has to be <i>plot</i>.</li>
</ul>
The <i>shiny</i> version of the Coder has many more examples and <b>covers almost all chart types</b>. Run in R environment with commands: <pre>library(echarty); demo(coder)</pre>
See also the <b>real-time data</b> processing <a href='realTime.html' target="_blank">Demo</a>.
	</p>
  </div>
</div>

<p><div class='wrapper'>
	<strong>Edit R code</strong> &nbsp; &nbsp; 
	<input type='button' id='btnCode' value='Plot &#x1F4CA' class='lefto bton'/> 
<span class='lefto'>Examples</span> &nbsp; &nbsp; 
<span class='lefto'>2D</span>  &nbsp;
	<input type="radio" id="bar" name="rchart" value="bar" onclick= 'rbHandler()'>
	<label for="bar">bar</label><br>
	<input type="radio" id="map" name="rchart" value="map" onclick= 'rbHandler()'>
	<label for="map">map</label><br>
<span class='lefto'>3D</span>  &nbsp;
	<input type="radio" id="xyz" name="rchart" value="xyz" onclick= 'rbHandler()'>
	<label for="xyz">xyz</label><br>
	<input type="radio" id="surface" name="rchart" value="surface" onclick= 'rbHandler()'>
	<label for="surface">surface</label><br>
	<input type="radio" id="globe" name="rchart" value="globe" onclick= 'rbHandler()'>
	<label for="globe">globe</label>
	<input type="radio" id="volcano" name="rchart" value="volcano" onclick= 'rbHandler()'>
	<label for="volcano">volcano</label>
	<input type='button' id='btnInfo' value='Info &#x1F4D3' class='lefto bton' />
	&nbsp; &nbsp; &nbsp; &nbsp; 
<!-- LikeBtn.com BEGIN -->
<span class="likebtn-wrapper" data-ef_voting="bounce" data-identifier="item_1" data-dislike_enabled="false"></span>
<script>(function(d,e,s){if(d.getElementById("likebtn_wjs"))return;a=d.createElement(e);m=d.getElementsByTagName(e)[0];a.async=1;a.id="likebtn_wjs";a.src=s;m.parentNode.insertBefore(a, m)})(document,"script","//w.likebtn.com/js/w/widget.js");</script>
<!-- LikeBtn.com END -->

   </div>
   <textarea id='code' class='textarea' cols=50 rows=7 contenteditable>plot <- cars |> ec.init()</textarea>
	
   <div id="app" class='center'>Loading WebR magic... <img src='../img/rubikon.gif' /></div>
</p>

	<script>
/*	does not work:
	load,  ec.plugjs (FS error)
*/
var webR;
import('https://webr.r-wasm.org/latest/webr.mjs').then(async ({ WebR }) => {
  webR = new WebR();
  await webR.init();
  await webR.evalRString(`
	webr::shim_install()
	install.packages('echarty', repos= c('https://repo.r-wasm.org'))
	'some string'
  `)
  document.getElementById('app').innerHTML = 'Ready to plot &#x1f44d';
});

async function rbHandler(v) {
	var ele = document.getElementsByName('rchart');
	for (i = 0; i < ele.length; i++) {
	    if (ele[i].checked)
		switch(ele[i].value) {
	  	  case 'bar':
		code= `dates <- seq(as.Date('2019-12-30'), as.Date('2020-01-12'), by='days')
df <- data.frame(date= dates,  num=runif(length(dates)))
plot <- df |> ec.init(ctype= 'bar',
  xAxis= list(type='category', axisLabel=list(interval=0, rotate=45))
) |> ec.theme('dark')`
		    break;

	  	  case 'xyz':
		code= `df <- mtcars |> mutate(name=rownames(mtcars)) |> relocate(mpg,wt,hp) |> group_by(cyl) 
series <- lapply(seq_along(df |> group_split()), function(ii,arr) { 
       list(type= 'scatter3D', datasetIndex=ii+1, name=unique(arr[[ii]]$cyl) ) }, arr=df |> group_split()) 
plot <- df |> ec.init( preset=F,  
  backgroundColor= '#777', width='70%', tooltip=list(show=T), legend= list(show=T),
  grid3D= list(list(show=T)), xAxis3D= list(show=T), yAxis3D= list(show=T), zAxis3D= list(show=T), 
  title= list(text='mtcars'), series =series 
)` 
		    break;

	  	  case 'surface':
		code= `data <- expand.grid(
  x = seq(0, 2, by = 0.1),
  y = seq(0, 1, by = 0.1)
) |> mutate(z = x * (y ^ 2)) |> select(x,y,z)
plot <- ec.init(preset=F,  # dont load='3D',
  xAxis3D= list(scale=T), yAxis3D= list(scale=T), zAxis3D= list(scale=T), grid3D= list(list(s=T)),
  series= list(list(
  type= 'surface', data= ec.data(data,'values'))) )`
		    break;
		  case 'globe':
		code= `plot <- ec.init(preset=F,
  globe= list(
    baseTexture='https://cdn.jsdelivr.net/gh/ecomfe/echarts-gl@master/test/asset/world.topo.bathy.200401.jpg',
    light= list(ambient= list(intensity=0.6)),
    shading= 'realistic', viewControl= list(autoRotate=F)),
  series= list(list(type= 'scatter3D', coordinateSystem='globe', 
    data= list(c(111,55,5), c(-117,33,1), list(name='h2', value= c(-77,11,2))), 
    symbolSize= 40, itemStyle= list(color= 'red')
  )), tooltip= list(show=T) )`
		    break;
		  case 'volcano':
		code= `data(volcano)
df <- as.data.frame(ec.data(as.data.frame(as.table(volcano)), TRUE)); colnames(df)<-NULL
plot <- ec.init( preset=F, 
  xAxis3D= list(scale=T), yAxis3D= list(scale=T), zAxis3D= list(scale=T),
  grid3D= list(viewControl= list(autoRotate= TRUE)),
  series= list(list(
    type = 'surface'
    ,data = ec.data(as.data.frame(as.table(volcano)), 'values')
    ,wireframe= list(show= FALSE)
    ,shading= 'realistic', realisticMaterial= list( metalness= 0.5, roughness= 0.6)
  )),
  visualMap= list(calculable=TRUE, dimension=3, inRange=list(color= rev(rainbow(10))) )
)`
		    break;
		  case 'map':
		code= `set.seed(222)
cns <- data.frame(   
  visualMap = c(T,T,T,F),
  name = c('China','Canada','Australia','Brazil'),
  value = runif(4, 1, 100) 
)
plot <- ec.init(load='world',
  color= c('violet','green'), 
  geo= list(map= 'world', roam= T),
  series= list(list(type= 'map', 
  	 data= ec.data(cns, 'names'))),
  visualMap= list(calculable= TRUE, max= 100)
)`
		    break;
		  default:
		}
	}
	document.getElementById('code').value = code;
}

const btnCode = document.getElementById("btnCode");
btnCode.addEventListener("click", updCode);

async function updCode() {
  document.getElementById('app').innerHTML= 'Wait...';
  code = 'library(echarty);library(dplyr); \n' + document.getElementById('code').value;
	//console.log(code);
  code += '\n as.character(htmlwidgets:::as.tags.htmlwidget(plot))'
  tags_plot = '';
  try {
    tags_plot = await webR.evalRString(code);
  } catch ({ name, message }) {
    tags_plot = "<div class='err'>Error<br/>" + message + '</div>';
  } finally {
	// add reactable tags from webR into DOM
	document.getElementById('app').innerHTML = tags_plot;
  }
  // render with HTMLWidgets
  HTMLWidgets.staticRender();
}

// Get the modal
var modal = document.getElementById("myModal");

// Get the button that opens the modal
var btn = document.getElementById("myBtn");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks the button, open the modal 
btnInfo.onclick = function() {
  modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}
	</script>
  </body>
</html>

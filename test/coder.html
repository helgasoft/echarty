<!DOCTYPE html>
<html lang="en">
<head>
	<title>WebR + echarty</title>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width" />
	<link rel="shortcut icon" href="../img/logo.ico" type="image/x-icon">
	
	<!--  ECharts sources  -->
	<script src="https://cdn.jsdelivr.net/npm/echarts@latest/dist/echarts.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/echarts-gl@2.0.9/dist/echarts-gl.min.js"></script>
	<!--  echarty dependencies  -->
	<script src="https://cdn.jsdelivr.net/gh/ramnathv/htmlwidgets@v1.6.4/inst/www/htmlwidgets.js"></script>
	<script src="https://cdn.jsdelivr.net/gh/helgasoft/echarty@v.1.6.4/inst/htmlwidgets/echarty.min.js"></script>
	<script src="https://cdn.jsdelivr.net/gh/helgasoft/echarty@v.1.6.4/inst/js/renderers.min.js"></script>

	<!--  echarty plugins  -->
	<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css">
	<script src="https://cdn.jsdelivr.net/gh/helgasoft/echarty@v.1.6.4/inst/js/echarts-leaflet.min.js"></script>
	<script src="https://cdn.jsdelivr.net/gh/helgasoft/echarty@v.1.6.4/inst/js/world.js"></script>

	<style>
body { font-family: Arial, sans-serif; background-color: Linen; }
a:link { text-decoration: none; }
.titl {font-size: 130%; }
.fontu {font-size: 130%;}
.center { text-align: center; }
.wrapper { display: flex; 
  margin: 0.5rem;   
  width: 100%;
} 
.textarea {
  border: 1px solid #ccc;
  padding: 1px 6px; margin: 5px;
  /*display: block;*/
  width: 70%;
  overflow: hidden;
  overflow-y: auto;
  resize: both;
  min-height: 40px;
  line-height: 20px;
  font-family: Verdana,sans-serif;
  font-size: 16px;
  background-color: #f8f8f8;
}
label {
  display: grid;
  /* grid-template-columns: auto 1fr; */
  align-items: center;
  margin-right: 6px;
}
.lefto { margin-left: 30px; }
.bton {font-size: 14px; background-color: PaleTurquoise; border-radius: 6px;}
.err {color: red;}

/* The Modal (background) */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
  background-color: Linen;
  margin: auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
}

/* The Close Button */
.close {
  color: #aaaaaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}
.nowrap { text-wrap: nowrap;}
.inblock { display:inline-block; }
	</style>

	<script>
/*	TODO:  1. how to dnld from r-universe.dev without ".rds. error
		2. upd liveData too
https://github.com/r-wasm/webr/issues/435
3. echarty - compile to Webass + mount from github.io
https://github.com/georgestagg/shiny-standalone-webr-demo/blob/main/shiny.js
   await webR.evalRVoid(`webr::mount("/shiny", "${window.location.href}/image/library.data")`);
*/
var webR, fjson;
import('https://webr.r-wasm.org/latest/webr.mjs').then(async ({ WebR }) => {
  webR = new WebR(); msg = document.getElementById('wver');
  await webR.init(); 
  wver= 'WebR v.'+ webR.version; console.log(wver);    
/*	// older versions from repo.r-wasm.org, separate == slower?
  await Promise.all(["htmlwidgets","dplyr","data.tree"].map(async (nn) => {
	msg.innerHTML = wver+ ', loading '+nn+'...'; webR.installPackages([nn]);
  }) ); */
msg.innerHTML = wver+ ', loading htmlwidgets...'; await webR.installPackages(['htmlwidgets'], repos='https://ramnathv.r-universe.dev')
msg.innerHTML = wver+ ', loading dplyr...'; await webR.installPackages(['data.tree'], repos='https://gluc.r-universe.dev')
msg.innerHTML = wver+ ', loading data.tree...'; await webR.installPackages(['dplyr'], repos='https://tidyverse.r-universe.dev')

  msg.innerHTML = wver+ ', loading echarty...'; await webR.installPackages(["echarty"], {repos:'https://helgasoft.r-universe.dev'});  // latest
  await webR.objs.globalEnv.bind('ec.webR', true);   // inform R about web environment
  document.getElementById('app').innerHTML = 'Ready to plot &#x1f4ca' ;   //&#x1f44d  
});

function rbHandler() {
	var ele = document.getElementById('rchart');
		switch(ele.value) {
		  case 'remote':
		code= `chart <- ec.fromJson(url('https://helgasoft.github.io/echarty/test/pfull.json'))`;
		    break;
	  	  case 'bar':
		code= `dates <- seq(as.Date('2019-12-30'), as.Date('2020-01-12'), by='days')
df <- data.frame(date= dates,  num=runif(length(dates)))
chart <- df |> ec.init(ctype= 'bar',
  xAxis= list(type='category', axisLabel=list(interval=0, rotate=45))
) |> ec.theme('dark')`;
		    break;
		  case 'map':
		code= `set.seed(222)
cns <- data.frame(   
  visualMap = c(T,T,T,F),
  name = c('China','Canada','Australia','Brazil'),
  value = runif(4, 1, 100) 
)
chart <- ec.init(load='world',
  color= c('violet','green'), 
  series.param= list(type= 'map', data= ec.data(cns, 'names')),
  visualMap= list(calculable= TRUE, max= 100)
)`
		    break;
		  case 'leaflet':
		code= `chart <- mtcars |> ec.init(load='leaflet', tooltip=list(s=T))`
		    break;

	  	  case 'xyz':
		code= `df <- mtcars |> mutate(name=rownames(mtcars)) |> relocate(mpg,wt,hp) |> group_by(cyl) 
chart <- df |> ec.init( load='3D',
  backgroundColor= '#777', width='70%', tooltip=list(show=T), legend= list(show=T), 
  title= list(text='mtcars')
)` 
		    break;

	  	  case 'surface':
		code= `df <- expand.grid(
  x = seq(0, 2, by = 0.1),
  y = seq(0, 1, by = 0.1)
) |> mutate(z = x * (y ^ 2)) |> select(x,y,z)
chart <- ec.init(load='3D', series.param= list(type= 'surface', data= ec.data(df,'values')) )`
		    break;
		  case 'globe':
		code= `chart <- ec.init(load='3D',
  globe= list(
    baseTexture='https://cdn.jsdelivr.net/gh/ecomfe/echarts-gl@master/test/asset/world.topo.bathy.200401.jpg',
    light= list(ambient= list(intensity=0.6)),
    viewControl= list(autoRotate=F)),
  series.param= list(type= 'scatter3D',
    data= list(list(value=c(0,0,111), symbolSize=0), c(-117,-13,33), list(name='h2', value= c(-77,11,24))),
    symbolSize= 40, itemStyle= list(color= 'red')
  ), tooltip= list(show=T) )`
		    break;
		  case 'volcano':
		code= `data(volcano)
df <- as.data.frame(as.table(volcano)) |> mutate(across(0:2, as.numeric))
chart <- ec.init(load='3D',  # grid3D= list(viewControl= list(autoRotate= TRUE)),
  series.param= list( type= 'surface', data= ec.data(df),
    wireframe= list(show= FALSE),
    shading= 'realistic', realisticMaterial= list( metalness= 0.5, roughness= 0.6)
  ),
  visualMap= list(calculable=TRUE, dimension=3, inRange=list(color= rev(rainbow(10))) )
)`
		    break;

		  default:
		}
	//}
	document.getElementById('code').value = code;
}

async function updCode() {
  document.getElementById('app').innerHTML= 'Wait...';
  exec = 'library(echarty);library(dplyr); \n' + document.getElementById('code').value +
  	    '\n as.character(htmlwidgets:::as.tags.htmlwidget(chart))'
  tags_plot = '';
  try {
	tags_plot = await webR.evalRString(exec);
  } catch ({ name, message }) {
	tags_plot = "<div class='err'>Error<br/>" + message + '</div>';
  } finally {
	// add tags from webR into DOM
	document.getElementById('app').innerHTML = tags_plot;
	fjson = await webR.evalRString("chart |> ec.inspect(target='full')");
	var blob = new Blob([fjson], {type: "text/plain"});
	var dlink = document.getElementById('dlink');
	dlink.href = window.URL.createObjectURL(blob);
	dlink.innerHTML = 'Export';
  }
  // render with HTMLWidgets
  HTMLWidgets.staticRender();
}

	</script>
</head>

<body>
  <div class='center'>
	<a href='https://github.com/helgasoft/echarty'><img src='../img/logo.png' width=40 /> <span class='titl'>Echarty</span></a> <span class='fontu'>WebR Coder</span>
  </div>

  <!-- The Modal -->
  <div id="myModal" class="modal">
  <!-- Modal content -->
  <div class="modal-content">
    <span class="close">&times;</span>
	<p>
<h4><a href='https://helgasoft.github.io/echarty' target=_blank>echarty</a> Coder on <a href='https://docs.r-wasm.org/webr/latest/' target=_blank>WebR</a></h4>
Live R-code execution inside a single web page. No Rmd files. No server. No installation. At last!
<p>You can experiment by setting chart attributes from <a href='https://echarts.apache.org/en/option.html' target=_blank>ECharts API</a>, for instance adding a <a href='https://echarts.apache.org/en/option.html#title' target=_blank>title</a>. 
ECharts attributes are defined as named lists in R.<br>
<b>Export</b> chart: plot and click hyperlink 'Export'. A file <i>fullChart.json</i> will be saved in browser's download folder.<br>
<b>Import</b> and plot code: <i>chart <- ec.fromJson(url('https://localhost/.../fullChart.json'))</i>
</p>
This page has coding singularities: <ul>
  <li>all JS plugins should be preloaded in the page <i>head</i> section. Parameter <i>load</i> in ec.init() will build presets, but will not load plugins.</li>
  <li>name of echarty widget has to be <i>chart</i>.</li>
  <li>currently echarty dependencies are loaded from a slow repo, improving the speed is in our ToDo list.</li>
</ul>
The <i>Shiny</i> version of the Coder has many more examples and <b>covers almost all chart types</b>. Run in R environment with commands: <pre>library(echarty); demo(coder)</pre>
See also the <b>real-time data</b> processing <a href='realTime.html' target="_blank">Demo</a>.
	</p>
  </div>
</div>

<p><div class='wrapper nowrap'>
	<span><strong>Edit R code</strong></span> &nbsp; &nbsp; 
	<input type='button' id='btnCode' value='Plot &#x1F4CA' class='lefto bton'/>  <!--  onclick='updCode()' -->
<span class='lefto'>Examples</span> &nbsp; &nbsp; 
<select name="rchart" id="rchart" onchange= 'rbHandler()'>
  <option value="">-- choose a chart --</option>
  <option value="remote">remote chart import</option>
<optgroup label="2D">
  <option value="bar">bar</option>
  <option value="map">world map</option>
  <option value="leaflet">leaflet map</option> </optgroup>
<optgroup label="3D">
  <option value="xyz">scatter3D</option>
  <option value="surface">simple surface</option>
  <option value="volcano">volcano surface</option>
  <option value="globe">globe</option>  </optgroup>
</select>
	<input type='button' id='btnInfo' value='Info &#x1F4D3' class='lefto bton' />
	&nbsp; &nbsp; &nbsp; &nbsp; 
<!-- LikeBtn.com BEGIN -->
<span class="likebtn-wrapper" data-ef_voting="bounce" data-identifier="item_1" data-dislike_enabled="false"></span>
<script>(function(d,e,s){if(d.getElementById("likebtn_wjs"))return;a=d.createElement(e);m=d.getElementsByTagName(e)[0];a.async=1;a.id="likebtn_wjs";a.src=s;m.parentNode.insertBefore(a, m)})(document,"script","//w.likebtn.com/js/w/widget.js");</script>
<!-- LikeBtn.com END -->

   </div>
   <textarea id='code' class='textarea inblock' cols=20 rows=7 contenteditable>
tmp <- help(package="echarty", help_type='text')
title <- list(text= paste('echarty', gsub(' ','',tmp$info[[1]][4])), left='center')
chart <- cars |> ec.init(title= title)
   </textarea>
   <a id='dlink' class='inblock' download='fullChart.json' onclick='dclick()'></a>
	
   <div id="app" class='center'><div id='wver'>Loading WebR magic... </div><img src='../img/rubikon.gif' /></div>
</p>

	<script>
const btnCode = document.getElementById("btnCode");
btnCode.addEventListener("click", updCode);

function dclick(e) {
  // revokeObjectURL needs a delay to work properly
  var that = this;
  setTimeout(function() {
      window.URL.revokeObjectURL(that.href);
  }, 1500);
};
// Get the modal
var modal = document.getElementById("myModal");

// Get the button that opens the modal
var btn = document.getElementById("myBtn");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks the button, open the modal 
btnInfo.onclick = function() {
  modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}
	</script>
  </body>
</html>
